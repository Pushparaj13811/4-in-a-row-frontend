name: Deploy Frontend to AWS EC2

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'tsconfig.json'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_WS_URL: ${{ secrets.VITE_WS_URL }}
        run: npm run build

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem

          # Create deployment package
          tar -czf frontend-dist.tar.gz -C dist .

          # Copy to EC2
          scp -i ec2_key.pem -o StrictHostKeyChecking=no \
            frontend-dist.tar.gz ${EC2_USER}@${EC2_HOST}:/tmp/

          # Deploy on EC2
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e

            # Create frontend directory if it doesn't exist
            sudo mkdir -p /var/www/pushparaj

            # Backup existing files
            sudo mkdir -p /var/www/pushparaj.backup
            sudo cp -r /var/www/pushparaj/* /var/www/pushparaj.backup/ 2>/dev/null || true

            # Clear old files
            sudo rm -rf /var/www/pushparaj/*

            # Extract new build
            sudo tar -xzf /tmp/frontend-dist.tar.gz -C /var/www/pushparaj/

            # Set correct permissions
            sudo chown -R www-data:www-data /var/www/pushparaj
            sudo chmod -R 755 /var/www/pushparaj

            # Check if Nginx is installed
            if ! command -v nginx &> /dev/null; then
              echo "⚠️ Warning: Nginx not installed. Installing..."
              sudo apt update && sudo apt install -y nginx
            fi

            # Create Nginx config if it doesn't exist
            if [ ! -f /etc/nginx/sites-available/4-in-a-row ]; then
              echo "Creating Nginx configuration..."
              sudo tee /etc/nginx/sites-available/4-in-a-row > /dev/null <<NGINX
server {
    listen 80;
    server_name _;

    root /var/www/pushparaj;
    index index.html;

    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    location / {
        try_files \$uri \$uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
NGINX

              # Enable site
              sudo ln -s /etc/nginx/sites-available/4-in-a-row /etc/nginx/sites-enabled/ || true
              sudo rm -f /etc/nginx/sites-enabled/default
            fi

            # Test and reload nginx
            sudo nginx -t && sudo systemctl reload nginx

            # Cleanup
            rm /tmp/frontend-dist.tar.gz
          EOF

          # Cleanup local key
          rm ec2_key.pem

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          sleep 3
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${EC2_HOST})
          if [ $HTTP_CODE -eq 200 ]; then
            echo "✅ Frontend deployed successfully"
          else
            echo "❌ Deployment verification failed (HTTP $HTTP_CODE)"
            exit 1
          fi
