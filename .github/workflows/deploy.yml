name: Deploy Frontend to AWS EC2

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'tsconfig.json'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          VITE_WS_URL: ${{ secrets.VITE_WS_URL }}
        run: |
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem

          # Create deployment package (source files)
          tar -czf frontend-source.tar.gz --exclude=node_modules --exclude=dist --exclude=.git .

          # Copy to EC2
          scp -i ec2_key.pem -o StrictHostKeyChecking=no \
            frontend-source.tar.gz ${EC2_USER}@${EC2_HOST}:/tmp/

          # Deploy on EC2
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << EOF
            set -e

            # Create frontend build directory
            mkdir -p /home/ubuntu/GATI-mail-backend/test/4-in-a-row-frontend

            # Extract source files
            cd /home/ubuntu/GATI-mail-backend/test/4-in-a-row-frontend
            tar -xzf /tmp/frontend-source.tar.gz

            # Install dependencies and build on server
            npm ci
            VITE_WS_URL="${VITE_WS_URL}" npm run build

            # Create web directory if it doesn't exist
            sudo mkdir -p /var/www/pushparaj

            # Backup existing files
            sudo mkdir -p /var/www/pushparaj.backup
            sudo cp -r /var/www/pushparaj/* /var/www/pushparaj.backup/ 2>/dev/null || true

            # Clear old files
            sudo rm -rf /var/www/pushparaj/*

            # Copy new build to web directory
            sudo cp -r dist/* /var/www/pushparaj/

            # Set correct permissions
            sudo chown -R www-data:www-data /var/www/pushparaj
            sudo chmod -R 755 /var/www/pushparaj

            # Reload nginx to pick up new files
            sudo systemctl reload nginx

            # Cleanup
            rm /tmp/frontend-source.tar.gz
          EOF

          # Cleanup local key
          rm ec2_key.pem

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem

          sleep 3

          # Check if files were deployed
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
            if [ -f /var/www/pushparaj/index.html ]; then
              echo "âœ… Frontend files deployed successfully"
              echo "ðŸ“ Deployed files:"
              ls -lh /var/www/pushparaj/ | head -n 10
              exit 0
            else
              echo "âŒ Frontend deployment verification failed"
              exit 1
            fi
          EOF

          rm ec2_key.pem
